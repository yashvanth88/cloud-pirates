name: CI/CD Deploy to Civo

on:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to registry
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.DOCKER_REGISTRY_HOST || 'ghcr.io' }}
          username: ${{ secrets.DOCKER_REGISTRY_USERNAME }}
          password: ${{ secrets.DOCKER_REGISTRY_PASSWORD }}

      - name: Build and push backend
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: "${{ secrets.DOCKER_REGISTRY_HOST || 'ghcr.io' }}/${{ secrets.REGISTRY_OWNER || github.repository_owner }}/cloud-pirates-backend:main-${{ github.run_number }}"

      - name: Build and push frontend
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: "${{ secrets.DOCKER_REGISTRY_HOST || 'ghcr.io' }}/${{ secrets.REGISTRY_OWNER || github.repository_owner }}/cloud-pirates-frontend:main-${{ github.run_number }}"

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install civo CLI
        run: |
          set -euo pipefail
          ASSET_URL=$(curl -s "https://api.github.com/repos/civo/cli/releases/latest" | grep "browser_download_url" | grep -i "linux" | grep -i "amd64" | head -n1 | cut -d '"' -f4)
          if [ -z "$ASSET_URL" ]; then
            echo "civo asset not found" >&2
            exit 1
          fi
          curl -L --retry 3 --fail -o /tmp/civo.tar.gz "$ASSET_URL"
          tar -xzf /tmp/civo.tar.gz -C /tmp
          sudo mv /tmp/civo /usr/local/bin/civo
          sudo chmod +x /usr/local/bin/civo

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Save kubeconfig
        env:
          CIVO_API_KEY: ${{ secrets.CIVO_API_KEY }}
          CLUSTER_NAME: ${{ secrets.CIVO_CLUSTER_NAME }}
        run: |
          set -euo pipefail
          civo --access-token "$CIVO_API_KEY" kubernetes kubeconfig save "$CLUSTER_NAME" > /tmp/kubeconfig 2>/dev/null || true
          if [ -s /tmp/kubeconfig ]; then
            mkdir -p $HOME/.kube
            mv /tmp/kubeconfig $HOME/.kube/config
          fi
          if [ -f "kubeconfig-$CLUSTER_NAME.yaml" ]; then
            mkdir -p $HOME/.kube
            mv "kubeconfig-$CLUSTER_NAME.yaml" $HOME/.kube/config
          fi
          export KUBECONFIG=$HOME/.kube/config
          echo "---- KUBECONFIG (first 20 lines) ----"
          sed -n '1,20p' $KUBECONFIG || true
          kubectl --kubeconfig=$KUBECONFIG version --client || true
          kubectl --kubeconfig=$KUBECONFIG cluster-info || true

      - name: Apply manifests and patch images
        env:
          KUBECONFIG: ${{ env.HOME }}/.kube/config
          BACKEND_IMG: "${{ secrets.DOCKER_REGISTRY_HOST || 'ghcr.io' }}/${{ secrets.REGISTRY_OWNER || github.repository_owner }}/cloud-pirates-backend:main-${{ github.run_number }}"
          FRONTEND_IMG: "${{ secrets.DOCKER_REGISTRY_HOST || 'ghcr.io' }}/${{ secrets.REGISTRY_OWNER || github.repository_owner }}/cloud-pirates-frontend:main-${{ github.run_number }}"
        run: |
          set -euo pipefail
          kubectl apply -f k8s/minio-deployment.yaml || true
          kubectl apply -f k8s/backend-deployment.yaml
          kubectl apply -f k8s/frontend-deployment.yaml
          kubectl set image deployment/pirates-backend backend=$BACKEND_IMG --record || true
          kubectl set image deployment/pirates-frontend frontend=$FRONTEND_IMG --record || true
          kubectl rollout status deployment/pirates-backend --timeout=120s || true
          kubectl rollout status deployment/pirates-frontend --timeout=120s || true
          kubectl get svc pirates-frontend -o wide || true
